<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>EXP Galaga — Slim (Part 1/2)</title><style>:root{--bg:#0f1226;--fg:#e7e9ff;--a:#7aa2ff;--g:#9ef0c0;--r:#ff6b6b}html,body{margin:0;background:radial-gradient(1200px 800px at 50% 20%,#1a1f49 0%,var(--bg) 45%,#0b0e1d 100%);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-user-select:none;user-select:none}canvas{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.15));border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.4),inset 0 0 0 1px rgba(255,255,255,.08);outline:none;touch-action:none;max-width:100%;height:auto}.wrap{display:flex;justify-content:center;align-items:flex-start;padding:12px 8px}.stage{position:relative;display:block;width:100%;max-width:900px;margin:0 auto}.hud{display:flex;justify-content:center;gap:12px;font-weight:600;margin-bottom:8px}.pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.06)}.controls{margin-top:8px;opacity:.9;font-size:clamp(12px,2.5vw,14px);text-align:center}.name-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9}.name-modal{background:#1b1f3a;border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:16px;width:min(92vw,360px);box-shadow:0 10px 30px rgba(0,0,0,.45)}.name-modal input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--fg);outline:none}.name-modal .actions{display:flex;gap:8px;margin-top:12px}.name-modal button{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--fg)}</style></head><body><div class="wrap"><div class="stage"><div class="hud"><div class="pill">Score: <span id="score">0</span></div><div class="pill">Best: <span id="best">0</span></div><div class="pill">Lives: <span id="lives">3</span></div><div class="pill">Wave: <span id="wave">1</span></div></div><canvas id="game" width="420" height="540" tabindex="0" aria-label="EXP Galaga"></canvas><div class="controls pill">Move: ◀ ▶ / A D • Fire: Space / K • Pause: P • Name: N • Reset Best: B</div><div class="name-modal-backdrop" id="nameModal" role="dialog" aria-modal="true"><div class="name-modal"><h3 style="margin:0 0 10px;text-align:center">Enter your player name</h3><input id="nameField" maxlength="20" placeholder="e.g., NightOwl"/><div class="actions"><button id="saveNameBtn">Save</button><button id="cancelNameBtn">Cancel</button></div></div></div></div></div><script>(function(){const $=id=>document.getElementById(id),cv=$('game'),cx=cv.getContext('2d');const W=cv.width,H=cv.height,DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));cv.width=W*DPR;cv.height=H*DPR;cx.scale(DPR,DPR);function fit(){const m=16,p=cv.parentElement,w=(p?p.clientWidth:innerWidth)-m*2,d=Math.max(320,Math.min(w,900)),s=d/W;cv.style.width=d+'px';cv.style.height=(H*s)+'px'}addEventListener('resize',fit);fit();const C=(v,a,b)=>Math.max(a,Math.min(b,v)),R=(a,b)=>a+Math.random()*(b-a);const HUD={score:$('score'),best:$('best'),lives:$('lives'),wave:$('wave')};const S={run:!1,pause:!1,over:!1,t:0,score:0,best:Number(localStorage.getItem('eg_best')||0),lives:3,wave:1,stars:[],pBul:[],rock:[],eBul:[],E:[],PU:[],EX:[],lanes:[],spawnAt:0};const P={x:W/2-12,y:H-88,w:24,h:36,s:520,vx:0,rate:.5,cd:0,m:1,sh:0,base:'#7aa2ff',col:'#7aa2ff',dmg:1,plasma:!1,mCount:0};const MAXP=70;for(let i=0;i<80;i++)S.stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.8+.4,s:.1+Math.random()*.4});const keys=new Set();addEventListener('keydown',e=>{if(ui(e))return;const k=e.code;['ArrowLeft','ArrowRight','KeyA','KeyD','Space','KeyK','KeyP','KeyN','Enter','KeyB'].includes(k)&&e.preventDefault();keys.add(k);if(!S.run&&(k==='Space'||k==='Enter'))start();else if(S.over&&k==='Space')restart();else if(k==='KeyP')S.pause=!S.pause;else if(k==='KeyN')showName();else if(k==='KeyB')resetBest()});addEventListener('keyup',e=>{if(ui(e))return;keys.delete(e.code)});const nm=$('nameModal'),nf=$('nameField'),bn=$('saveNameBtn'),bc=$('cancelNameBtn');let nameOpen=!1,playerName=(localStorage.getItem('sq_player_name')||'').trim();function ui(e){const el=e&&e.target;return nameOpen||(el&&(el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable))}function ensureName(){if(playerName&&playerName.trim())return!0;playerName='Player';localStorage.setItem('sq_player_name',playerName);return!0}function showName(){S.pause=!0;keys.clear();nameOpen=!0;nm.style.display='flex';nf.value=(localStorage.getItem('sq_player_name')||playerName||'');setTimeout(()=>nf&&nf.focus(),0)}function hideName(){nameOpen=!1;nm.style.display='none'}function commitName(){const v=(nf.value||'').trim().slice(0,20);if(!v){nf.focus();return}playerName=v;localStorage.setItem('sq_player_name',playerName);hideName()}bn&&bn.addEventListener('click',commitName);bc&&bc.addEventListener('click',()=>{if(!playerName){playerName='Player';localStorage.setItem('sq_player_name',playerName)}hideName()});document.addEventListener('visibilitychange',()=>{if(document.hidden)S.pause=!0});function start(){if(S.run)return;if(!ensureName())return;Object.assign(S,{run:!0,over:!1,pause:!1,t:0,score:0,lives:3,wave:1});Object.assign(P,{x:W/2-P.w/2,vx:0,rate:.5,cd:0,m:1,mCount:0,sh:0,col:P.base,dmg:1,plasma:!1});initLanes();spawnWave();updHUD();raf(performance.now())}function restart(){S.over=!1;start()}function updHUD(){HUD.score.textContent=Math.floor(S.score);HUD.best.textContent=S.best;HUD.lives.textContent=S.lives;HUD.wave.textContent=S.wave}let last=performance.now();function raf(now){const dt=Math.min(.04,(now-last)/1000);last=now;if(!S.pause&&S.run&&!S.over)update(dt);draw();if(S.run)requestAnimationFrame(raf)}function shootDelay(w){return Math.max(.8,1.5-.07*(w||1))}function canShoot(){return(S.t-S.spawnAt)>=shootDelay(S.wave||1)}function initLanes(){const w=S.wave||1,per=Math.max(2.2,3.4-.1*w),win=Math.min(.9,.55+.01*w),cad=Math.max(.18,.32-.01*w);S.lanes=[];for(let i=0;i<3;i++)S.lanes.push({t:Math.random()*per*.8,on:!1,next:0,per:per*(.9+Math.random()*.25),win:win*(.9+Math.random()*.25),cad:cad*(.9+Math.random()*.25),i})}function update(dt){S.t+=dt;for(const s of S.stars){s.y+=(40+s.s*60)*dt;if(s.y>H+2){s.y=-2;s.x=Math.random()*W}}let vx=0;if(keys.has('ArrowLeft')||keys.has('KeyA'))vx-=1;if(keys.has('ArrowRight')||keys.has('KeyD'))vx+=1;P.vx=C(vx,-1,1);P.x=C(P.x+P.vx*P.s*dt,8,W-P.w-8);if((keys.has('Space')||keys.has('KeyK'))&&P.cd<=0)fire();if(P.cd>0)P.cd-=dt;for(const b of S.pBul)b.y+=b.vy*dt;S.pBul=S.pBul.filter(b=>b.y>-20);for(const r of S.rock)r.y+=r.vy*dt;S.rock=S.rock.filter(r=>r.y>-30);for(const b of S.eBul){b.y+=b.vy*dt;if(b.vx)b.x+=b.vx*dt}S.eBul=S.eBul.filter(b=>b.y<H+20&&b.x>-20&&b.x<W+20);const alive=S.E.filter(e=>e.alive);if(!alive.length){S.score+=Math.round(100+25*S.wave);S.wave++;updHUD();spawnWave()}const t=S.t;for(const e of S.E){if(!e.alive)continue;const sc=Math.min(1.5,1+S.wave*.05),wx=Math.sin(t*e.fx*sc+e.px)*e.ax+Math.sin(t*(e.fx*1.9)+e.px*.6)*e.ax*.4,wy=Math.sin(t*e.fy*sc+e.py)*e.ay;e.x=e.bx+wx;e.y=e.by+wy;if(!e.dash&&Math.random()<.002+S.wave*.0006){e.dash=1;e.dt=0;e.tx=R(20,W-20);e.ty=R(30,H*.6)}if(e.dash){e.dt+=dt;const a=Math.atan2(e.ty-e.y,e.tx-e.x);e.x+=Math.cos(a)*e.ds*dt;e.y+=Math.sin(a)*e.ds*dt;if(Math.hypot(e.tx-e.x,e.ty-e.y)<10||e.dt>2.2)e.dash=0}if(!e.div&&Math.random()<(e.t==='bomber'?.006+.001*S.wave:.004+.0007*S.wave)){e.div=1;e.vt=0}if(e.div){e.vt+=dt;const sp=(e.t==='bomber'?160:120)+60*Math.min(4,S.wave),a=Math.atan2(P.y-e.y,P.x+P.w/2-e.x);e.x+=Math.cos(a)*sp*dt;e.y+=Math.sin(a)*sp*dt;if(e.t==='bomber'){e.bc=(e.bc||0)-dt;if(e.bc<=0){addEB(e.x,e.y+10,260);e.bc=.65+Math.random()*.35}}if(e.y>H+30||e.vt>4)e.div=0}e.x=C(e.x,12,W-12);e.y=C(e.y,30,H-30)}if(canShoot()){for(const L of S.lanes){L.t+=dt;if(!L.on&&L.t>=L.per){L.on=1;L.next=0;L.t=0}if(!L.on)continue;L.next-=dt;if(L.next<=0){L.next=L.cad;const xL=L.i*(W/3),xR=(L.i+1)*(W/3);const pool=S.E.filter(e=>e.alive&&e.x>=xL&&e.x<xR&&(!e.ready||e.ready<=S.t));for(let i=pool.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[pool[i],pool[j]]=[pool[j],pool[i]]}const shooters=(S.wave>=11)?1:Math.min(1+((S.wave/5)|0),3),cnt=Math.min(shooters,pool.length),stag=.08+Math.random()*.06;for(let i=0;i<cnt;i++){const e=pool[i];if(e.t==='bomber'&&Math.random()<.65)continue;shot(e);e.ready=S.t+.35+Math.random()*.35}}if(L.t>=L.win)L.on=0}}// bullets vs enemies
for(let i=S.pBul.length-1;i>=0;i--){const b=S.pBul[i];let hit=!1;for(const e of S.E){if(!e.alive)continue;if(cir(b.x,b.y,b.r,e.x-9,e.y-7,18,14)){hit=!0;const d=b.dmg||1;if(e.sh&&e.sh>0){e.sh=Math.max(0,e.sh-d);boom(b.x,b.y,0)}else{e.hp-=d;boom(b.x,b.y,0);if(e.hp<=0){e.alive=!1;boom(e.x,e.y,1);S.score+=(e.t==='boss'?300:(e.t==='bomber'?80:(e.t==='beetle'?60:(e.t==='drone'?40:30))));if(Math.random()<.14)dropPU(e.x,e.y)}}break}}if(hit)S.pBul.splice(i,1)}for(let i=S.rock.length-1;i>=0;i--){const k=S.rock[i];let Ht=!1;for(const e of S.E){if(!e.alive)continue;if(cir(k.x,k.y,k.r,e.x-9,e.y-7,18,14)){Ht=!0;rBoom(k.x,k.y);break}}if(Ht)S.rock.splice(i,1)}const pr={x:P.x,y:P.y,w:P.w,h:P.h};for(let i=S.eBul.length-1;i>=0;i--){const b=S.eBul[i];if(cir(b.x,b.y,b.r,pr.x,pr.y,pr.w,pr.h)){S.eBul.splice(i,1);if(P.sh>0){P.sh--;boom(b.x,b.y,0)}else loseLife()}}for(const p of S.PU)p.y+=p.vy*dt;for(let i=S.PU.length-1;i>=0;i--){const p=S.PU[i];if(cir(p.x,p.y,p.r,pr.x,pr.y,pr.w,pr.h)){S.PU.splice(i,1);if(p.k==='cell')S.score+=p.v||25;else if(p.k==='rate')P.rate=Math.max(.05,P.rate*.9);else if(p.k==='multi'){P.m=Math.min(6,P.m+1);P.mCount=(P.mCount||0)+1}else if(p.k==='shield')P.sh+=2;else if(p.k==='plasma'){P.plasma=!0;P.col='#c77dff';P.dmg=2}}}for(const e of S.EX)e.t+=dt;S.EX=S.EX.filter(e=>e.t<.6);S.score+=dt*5;if(S.score>S.best){S.best=Math.floor(S.score);localStorage.setItem('eg_best',S.best)}updHUD()}function fire(){P.cd=P.rate;const cnt=Math.min(6,Math.max(1,P.m|0)),sp=7,cx=P.x+P.w/2;if(S.pBul.length>=MAXP){addR(cx-6,P.y-8,-900);addR(cx+6,P.y-8,-900);return}if((P.mCount||0)>8)addR(cx,P.y-10,-980);const st=-((cnt-1)/2|0);for(let i=0;i<cnt;i++){addB(cx+(st+i)*sp,P.y-6,-1450)}}function addB(x,y,vy){const r=P.plasma?3.1:2.6;S.pBul.push({x,y,vy,r,color:P.col||P.base,dmg:P.dmg||1})}function addR(x,y,vy){S.rock.push({x,y,vy,r:3.2})}function rBoom(x,y){boom(x,y,1);const R=58;for(const e of S.E){if(!e.alive)continue;const d=Math.hypot(e.x-x,e.y-y);if(d<=R){if(e.sh&&e.sh>0)e.sh=0;e.hp-=3;boom(e.x,e.y,0);if(e.hp<=0){e.alive=!1;boom(e.x,e.y,1);S.score+=(e.t==='boss'?300:(e.t==='bomber'?80:(e.t==='beetle'?60:(e.t==='drone'?40:30))));if(Math.random()<.14)dropPU(e.x,e.y)}}}}function addEB(x,y,vy=200,r=2.6,c='#ffb0b0',vx=0){S.eBul.push({x,y,vy,r,color:c,vx})}function boom(x,y,b){S.EX.push({x,y,t:0,b})}function cir(cx,cy,r,rx,ry,rw,rh){const nx=Math.max(rx,Math.min(cx,rx+rw)),ny=Math.max(ry,Math.min(cy,ry+rh));const dx=cx-nx,dy=cy-ny;return dx*dx+dy*dy<=r*r}function loseLife(){boom(P.x+P.w/2,P.y+P.h/2,1);if(P.sh>0){P.sh=0;return}S.lives--;if(S.lives<=0){S.over=!0;S.run=!1;submitHighScore(Math.floor(S.score))}else{P.cd=.4;P.sh=1}}function pLabel(k){return k==='cell'?'points':k==='rate'?'rate':k==='multi'?'multishot':k==='plasma'?'plasma':'shield'}function dropPU(x,y){const w=S.wave||1,r=Math.random();let k='cell';if(w>=11){k=r<.40?'cell':r<.60?'rate':r<.77?'multi':r<.97?'shield':'plasma'}else{k=r<.50?'cell':r<.72?'rate':r<.88?'multi':r<.97?'shield':'plasma'}const rad=10+Math.random()*4,vy=120+Math.random()*40,val=(20+Math.random()*30)|0;S.PU.push({x,y,r:rad,vy,k,v:val})}function aStyle(w,t){if(w<=4)return'single';if(w<=7)return t==='scout'&&Math.random()<.4?'double':'single';if(w<=10)return Math.random()<.4?'double':(t!=='scout'&&Math.random()<.25?'tri':'single');if(w<=14){const a=['double','tri','spray'];return a[(Math.random()*a.length)|0]}const hi=['tri','spray','fast','double'];return hi[(Math.random()*hi.length)|0]}function spawnWave(){S.E.length=0;S.spawnAt=S.t;initLanes();const w=S.wave||1,eff=Math.min(w,14),cols=4+Math.min(4,((eff-1)/2|0)),rows=2+Math.min(2,((eff-1)/4|0)),sx=(W-(cols-1)*36)/2,sy=80;let base=['scout','drone','beetle'];if(w>=15)base.push('bomber');const tCount=Math.min(1+((eff-1)/3|0),base.length),avail=base.slice(0,tCount),delay=shootDelay(w);for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){const t=avail[Math.min(r,avail.length-1)],ex=sx+c*36,ey=sy+r*30;let hp=t==='beetle'?3:(t==='drone'?2:1);if(t==='beetle')hp+=((w-1)/6|0);if(t==='drone'&&w>=9)hp++;let sh=0;if(t==='drone'&&Math.random()<(0.15+0.02*w))sh=1;if(t==='beetle')sh=(Math.random()<.5?1:2)+((w-1)/5|0);const e={t, bx:ex,by:ey,x:ex,y:ey,hp,sh,alive:!0,div:0,vt:0,px:Math.random()*6.28,py:Math.random()*6.28,fx:.6+Math.random()*.8,fy:.4+Math.random()*.7,ax:40+Math.random()*90,ay:20+Math.random()*70,dash:0,dt:0,tx:0,ty:0,ds:180+Math.random()*140,atk:'single'};e.ax*=(1+Math.min(.6,w*.05));e.ay*=(1+Math.min(.5,w*.04));const fS=1+Math.min(.3,w*.02);e.fx*=fS;e.fy*=fS;e.ds*=(1+Math.min(.4,w*.03));e.sh+=Math.max(0,((w-1)/6|0)-(t==='scout'?1:0));if(w>14){e.hp+=((w-14)/2|0);e.sh+=((w-14)/3|0)}e.atk=aStyle(w,t);e.ready=S.spawnAt+delay+Math.random()*.7;S.E.push(e)}if(w>=20){const bx=W/2,by=sy-20,hp=14+((w-20)*1.5|0),sh=4+((w-20)/3|0);const b={t:'boss',bx,by,x:bx,y:by,hp,sh,alive:!0,div:0,vt:0,px:0,py:0,fx:.3,fy:.2,ax:20,ay:10,dash:0,dt:0,tx:0,ty:0,ds:160,atk:'tri'};b.ready=S.spawnAt+shootDelay(w)+.5+Math.random()*.5;S.E.push(b)}}function shot(e){const v=200+12*S.wave+Math.random()*30; if(e.t==='boss'){addEB(e.x-5,e.y+10,v);addEB(e.x+5,e.y+10,v)}else if(e.atk==='double'){addEB(e.x-5,e.y+10,v);addEB(e.x+5,e.y+10,v)}else if(e.atk==='tri'){addEB(e.x-6,e.y+10,v);addEB(e.x,e.y+10,v);addEB(e.x+6,e.y+10,v)}else addEB(e.x,e.y+10,v)}function RR(x,y,w,h,r,col){cx.beginPath();cx.moveTo(x+r,y);cx.arcTo(x+w,y,x+w,y+h,r);cx.arcTo(x+w,y+h,x,y+h,r);cx.arcTo(x,y+h,x,y,r);cx.arcTo(x,y,x+w,y,r);cx.closePath();cx.fillStyle=col;cx.fill()}function drawShip(x,y,w,h,sh){RR(x,y,w,h,8,'#1f254a');cx.strokeStyle='rgba(255,255,255,.2)';cx.strokeRect(x+.5,y+.5,w-1,h-1);const nW=Math.max(10,(w*.38|0)),nH=Math.max(6,(h*.12|0)),nx=x+(w-nW)/2,ny=y-nH;RR(nx,ny,nW,nH,3,'#1f254a');cx.strokeRect(nx+.5,ny+.5,nW-1,nH-1);cx.fillStyle='#7aa2ff';cx.fillRect(x+8,y+8,w-16,8);cx.fillStyle='rgba(231,233,255,.95)';cx.font='bold 9px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.textAlign='center';cx.fillText('EXP48PRO',x+w/2,y+h/2+4);if(sh>0){const cx0=x+w/2,cy=y+h/2,br=Math.max(w,h)*.8;for(let i=0;i<sh;i++){const rr=br+i*4,a=Math.max(.2,.75-i*.08);cx.beginPath();cx.arc(cx0,cy,rr,0,Math.PI*2);cx.strokeStyle='rgba(158,240,192,'+a+')';cx.lineWidth=2;cx.stroke()}}}function drawEnemy(e){let w=24,h=20,col='#7aa2ff';if(e.t==='boss'){w=44;h=36;col='#ff9b42'}else if(e.t==='bomber'){w=26;h=22;col='var(--r)'}else if(e.t==='beetle'){col='#ffd76a'}else if(e.t==='drone'){col='var(--g)'}const x=e.x-w/2,y=e.y-h/2;RR(x,y,w,h,6,col);cx.save();cx.translate(e.x,e.y);cx.rotate(.05);cx.fillStyle='rgba(0,0,0,.35)';cx.beginPath();cx.moveTo(-4,-6);cx.lineTo(3,-6);cx.lineTo(-1,1);cx.lineTo(5,1);cx.lineTo(-2,10);cx.lineTo(0,2);cx.lineTo(-6,2);cx.closePath();cx.fill();cx.restore();if(e.sh&&e.sh>0){for(let i=0;i<e.sh;i++){cx.beginPath();cx.arc(e.x,e.y,Math.max(w,h)*.6+i*3,0,Math.PI*2);cx.strokeStyle='rgba(158,240,192,'+(0.65-i*0.12)+')';cx.lineWidth=1.5;cx.stroke()}}}function drawPU(p){const c=p.x,y=p.y,r=p.r;if(p.k==='plasma'){cx.beginPath();cx.arc(c,y,r+5,0,Math.PI*2);cx.fillStyle='rgba(199,125,255,.28)';cx.fill();cx.beginPath();cx.arc(c,y,r+2,0,Math.PI*2);cx.fillStyle='rgba(199,125,255,.2)';cx.fill();cx.beginPath();cx.arc(c,y,r,0,Math.PI*2);cx.fillStyle='#c77dff';cx.shadowColor='#c77dff';cx.shadowBlur=10;cx.fill();cx.shadowBlur=0;cx.fillStyle='#0f1226';cx.fillRect(c-1.2,y-r*.7,2.4,r*1.4);cx.fillRect(c-r*.7,y-1.2,r*1.4,2.4)}else{cx.beginPath();cx.arc(c,y,r+3,0,Math.PI*2);cx.fillStyle='rgba(158,240,192,.25)';cx.fill();cx.beginPath();cx.arc(c,y,r,0,Math.PI*2);cx.fillStyle='var(--g)';cx.fill();cx.fillStyle='#0f1226';cx.fillRect(c-1,y-r*.6,2,r*1.2);cx.fillRect(c-r*.6,y-1,r*1.2,2)}const L=pLabel(p.k);cx.save();cx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.textAlign='center';cx.textBaseline='bottom';cx.strokeStyle='rgba(0,0,0,.65)';cx.lineWidth=3;cx.strokeText(L,c,y-r-2);cx.fillStyle='#fff';cx.fillText(L,c,y-r-2);cx.restore()}function drawEX(ex){const life=ex.b?.6:.45,pr=Math.min(1,ex.t/life),R0=(ex.b?22:12)*(0.6+pr*1.2);cx.save();cx.globalAlpha=1-pr;cx.beginPath();cx.arc(ex.x,ex.y,R0,0,Math.PI*2);cx.fillStyle=ex.b?'rgba(255,215,122,.7)':'rgba(122,162,255,.7)';cx.fill();cx.restore()}function card(t,sub){cx.fillStyle='rgba(0,0,0,.45)';cx.fillRect(40,H/2-90,W-80,160);cx.strokeStyle='rgba(255,255,255,.15)';cx.strokeRect(40.5,H/2-89.5,W-81,159);cx.textAlign='center';cx.font='bold 28px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.shadowColor='rgba(122,162,255,.6)';cx.shadowBlur=12;cx.fillStyle='var(--fg)';cx.fillText(t,W/2,H/2-12);cx.shadowBlur=0;cx.font='14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillStyle='rgba(231,233,255,.9)';cx.fillText(sub,W/2,H/2+18)}function draw(){cx.clearRect(0,0,W,H);for(const s of S.stars){cx.globalAlpha=.5+Math.sin((s.x+s.y)*.05)*.25;cx.beginPath();cx.arc(s.x,s.y,s.r,0,Math.PI*2);cx.fillStyle='#e7e9ff';cx.fill()}cx.globalAlpha=1;const g=cx.createLinearGradient(0,H-140,0,H);g.addColorStop(0,'rgba(122,162,255,0)');g.addColorStop(1,'rgba(122,162,255,.15)');cx.fillStyle=g;cx.fillRect(0,H-140,W,140);drawShip(P.x,P.y,P.w,P.h,P.sh);for(const e of S.E)if(e.alive)drawEnemy(e);for(const b of S.pBul){cx.beginPath();cx.arc(b.x,b.y,b.r,0,Math.PI*2);cx.fillStyle=b.color;cx.fill()}for(const r of S.rock){cx.beginPath();cx.arc(r.x,r.y,r.r,0,Math.PI*2);cx.fillStyle='#ffd76a';cx.fill()}for(const b of S.eBul){cx.beginPath();cx.arc(b.x,b.y,b.r,0,Math.PI*2);cx.fillStyle=b.color||'#ffb0b0';cx.fill()}for(const p of S.PU)drawPU(p);for(const ex of S.EX)drawEX(ex);if(!S.run&&!S.over){drawHelp();drawLB()}if(S.over){card('MISSION FAILED','Space to Restart');drawLB()}}function drawHelp(){// header banner
RR(24,46,W-48,74,12,'rgba(0,0,0,.45)');cx.strokeStyle='rgba(255,255,255,.15)';cx.strokeRect(24.5,46.5,W-49,73);cx.textAlign='center';cx.fillStyle='var(--fg)';cx.font='bold 24px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillText('EXP Galaga',W/2,78);cx.font='13px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillStyle='rgba(231,233,255,.9)';cx.fillText('Survive waves, collect power-ups, climb the leaderboard',W/2,98);
// two info panels
const pw=(W-72)/2,py=130,ph=144,px1=24,px2=px1+pw+24; // controls
RR(px1,py,pw,ph,10,'rgba(0,0,0,.35)');cx.strokeStyle='rgba(255,255,255,.12)';cx.strokeRect(px1+.5,py+.5,pw-1,ph-1);cx.textAlign='left';cx.fillStyle='rgba(231,233,255,.95)';cx.font='bold 14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillText('Controls',px1+12,py+20);cx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';const cl=['Move: ◀ ▶ / A D','Fire: Space / K','Pause: P','Name: N','Reset Best: B'];for(let i=0;i<cl.length;i++)cx.fillText('• '+cl[i],px1+12,py+44+i*18);
// power-ups
RR(px2,py,pw,ph,10,'rgba(0,0,0,.35)');cx.strokeRect(px2+.5,py+.5,pw-1,ph-1);cx.fillStyle='rgba(231,233,255,.95)';cx.font='bold 14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillText('Power-ups',px2+12,py+20);cx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';const pu=[['points','var(--g)'],['rate','#7aa2ff'],['multishot','#e7e9ff'],['shield','#9ef0c0'],['plasma','#c77dff'],['rockets','#ffd76a']];for(let i=0;i<pu.length;i++){const yy=py+44+i*18;cx.beginPath();cx.arc(px2+16,yy-6,4,0,Math.PI*2);cx.fillStyle=pu[i][1];cx.fill();cx.fillStyle='rgba(231,233,255,.95)';cx.fillText(pu[i][0],px2+28,yy)}
// start prompt
cx.textAlign='center';cx.font='bold 14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillStyle='rgba(231,233,255,.95)';cx.fillText('Press Space / Enter to Start',W/2,H-28);}/* Leaderboard (Upstash or local fallback) */const LB_KEY='sq_leaderboard_v1';function loadLB(){try{return JSON.parse(localStorage.getItem(LB_KEY)||'[]')||[]}catch(_){return[]}}function saveLB(a){try{localStorage.setItem(LB_KEY,JSON.stringify(a))}catch(_){}}function upsertLBLocal(name,score){let lb=loadLB();const now=Date.now();const i=lb.findIndex(e=>e.name===name);if(i>=0){if(score>lb[i].score){lb[i].score=score;lb[i].date=now}}else{lb.push({name,score,date:now})}lb.sort((a,b)=>(b.score-a.score)||(a.date-b.date));if(lb.length>20)lb.length=20;saveLB(lb);const rank=lb.findIndex(e=>e.name===name)+1;return{rank,lb}}const API_BASE=(window.LEADERBOARD_API_BASE||'https://power-up-leaderboard.vercel.app/api/leaderboard'),LB_TIMEOUT_MS=5000;let remoteLB=null,lbLoading=!1,lastRank=null,lastLBSize=0;function drawLB(){const lb=(remoteLB&&remoteLB.length?remoteLB:loadLB());const pad=14,rowH=18,maxRows=8;const w=W-80,x=40;const h=pad*2+rowH*(Math.min(maxRows,lb.length||0)+3);const y=Math.min(H-(h+40),H/2+190);cx.fillStyle='rgba(0,0,0,.45)';cx.fillRect(x,y,w,h);cx.strokeStyle='rgba(255,255,255,.15)';cx.strokeRect(x+.5,y+.5,w-1,h-1);cx.textAlign='left';cx.font='bold 16px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillStyle='rgba(231,233,255,.95)';const title='Leaderboard';if(lbLoading&&(!remoteLB||!remoteLB.length)){cx.fillText(title+' — loading…',x+pad,y+pad+2);return}cx.fillText(title,x+pad,y+pad+2); // headers
cx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillStyle='rgba(231,233,255,.7)';cx.fillText('#',x+pad,y+pad+24);cx.fillText('Name',x+pad+18,y+pad+24);cx.textAlign='right';cx.fillText('Score',x+w-pad,y+pad+24);cx.textAlign='left';cx.strokeStyle='rgba(255,255,255,.08)';cx.beginPath();cx.moveTo(x+pad-2,y+pad+28);cx.lineTo(x+w-pad+2,y+pad+28);cx.stroke();
// rows
cx.font='14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';const show=(lb||[]).slice(0,maxRows);if(!show.length){cx.fillStyle='rgba(231,233,255,.75)';cx.fillText('No scores yet — be the first!',x+pad,y+pad+48)}else{const base=y+pad+44;for(let i=0;i<show.length;i++){const e=show[i];const lineY=base+i*rowH;const isMe=(playerName&&e.name===playerName);cx.fillStyle=isMe?'#9ef0c0':'rgba(231,233,255,.9)';cx.fillText(`${i+1}`,x+pad,lineY);cx.fillText(`${e.name}`,x+pad+18,lineY);cx.textAlign='right';cx.fillText(`${e.score}`,x+w-pad,lineY);cx.textAlign='left'}}if(playerName&&lb&&lb.length){const r=lb.findIndex(e=>e.name===playerName);if(r>=0&&r>=maxRows){cx.fillStyle='#9ef0c0';cx.fillText(`…  #${r+1}  ${playerName} — ${lb[r].score}`,x+pad,y+h-pad-18)}}cx.fillStyle='rgba(231,233,255,.7)';cx.font='12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto';cx.fillText('Press N to set your name'+(playerName?` (current: ${playerName})`:''),x+pad,y+h-pad);}function refreshLeaderboard(limit=20){lbLoading=!0;setTimeout(()=>{if(lbLoading){lbLoading=!1;if(!remoteLB)remoteLB=loadLB();draw()}},LB_TIMEOUT_MS+400);const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),LB_TIMEOUT_MS);fetch(`${API_BASE}?limit=${encodeURIComponent(limit)}`,{mode:'cors',signal:ctrl.signal}).then(r=>r.ok?r.json():Promise.reject(r.status)).then(res=>{remoteLB=(res&&res.lb)?res.lb:[];lbLoading=!1;draw()}).catch(()=>{lbLoading=!1;if(!remoteLB)remoteLB=loadLB();draw()}).finally(()=>clearTimeout(t))}function submitHighScore(final){const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),LB_TIMEOUT_MS);return fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:playerName||'Player',score:final}),mode:'cors',signal:ctrl.signal}).then(r=>r.ok?r.json():Promise.reject(r.status)).then(res=>{remoteLB=(res&&res.lb)?res.lb:remoteLB;lastRank=(res&&res.rank!=null)?res.rank:lastRank;lastLBSize=(remoteLB?remoteLB.length:lastLBSize);draw();return res}).catch(()=>{const {rank,lb}=upsertLBLocal(playerName||'Player',final);lastRank=rank;lastLBSize=lb.length;if(!remoteLB)remoteLB=lb;draw();return{rank,lb}}).finally(()=>clearTimeout(t))}function resetBest(){S.best=0;localStorage.removeItem('eg_best');updHUD();boom(W/2,60,1)}
setTimeout(()=>cv.focus(),0);updHUD();refreshLeaderboard();draw();})();</script></body></html>
